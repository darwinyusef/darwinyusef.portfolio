---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import { getCollection } from "astro:content";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const servicesFromContent = await getCollection("services");
---

<Layout title={t("services.title")}>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <div class="min-h-screen bg-[#F8F8F8] dark:bg-[#0a0a0a]">
    <Header />

    <main class="overflow-hidden px-5">
      <!-- Hero Section con Ultra Large Text -->
      <section class="relative min-h-[70vh] flex items-center justify-center py-20">
        <div class="max-w-[1800px] mx-auto w-full">
          <div class="text-center">
            <h1 class="text-[clamp(3rem,12vw,12rem)] font-black leading-[0.9] tracking-tighter text-gray-900 dark:text-white mb-8" style="font-family: 'Inter Tight', system-ui, sans-serif;">
              {lang === 'es' ? 'MIS' : lang === 'en' ? 'MY' : 'MEUS'}
              <br />
              <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary via-purple-600 to-pink-600">
                {lang === 'es' ? 'SERVICIOS' : lang === 'en' ? 'SERVICES' : 'SERVI√áOS'}
              </span>
            </h1>
            <p class="text-xl md:text-2xl text-gray-600 dark:text-gray-400 max-w-3xl mx-auto leading-relaxed" style="font-family: 'Inter Tight', system-ui, sans-serif;">
              {lang === 'es'
                ? 'Servicios profesionales de desarrollo y tecnolog√≠a para impulsar tu negocio.'
                : lang === 'en'
                ? 'Professional development and technology services to boost your business.'
                : 'Servi√ßos profissionais de desenvolvimento e tecnologia para impulsionar seu neg√≥cio.'}
            </p>
          </div>
        </div>
      </section>

      <section class="pb-16 max-w-7xl mx-auto relative z-10">
      <div
        id="services-container"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
      >
        <div class="text-center py-8 col-span-full">
          <p class="text-gray-600 dark:text-gray-400">Cargando servicios...</p>
        </div>
      </div>
      </section>
    </main>
  </div>
</Layout>

<script>
  const backendUrl = "http://localhost:8000";

  interface Service {
    id: number;
    name: string;
    description: string;
    price?: number;
    duration?: string;
    is_active: boolean;
    icon?: string;
  }

  function normalizeIconName(
    iconString: string | undefined | null
  ): string | null {
    if (!iconString) return null;
    // quitar prefijo Lu/lu si existe
    let s = iconString.replace(/^Lu|^lu/, "");
    // PascalCase -> kebab-case
    s = s
      .replace(/([a-z0-9])([A-Z])/g, "$1-$2")
      .replace(/([A-Z])([A-Z][a-z])/g, "$1-$2")
      .replace(/_/g, "-")
      .toLowerCase();
    return s;
  }

  // Tipado expl√≠cito para evitar problemas con `ICON_SVGS[name]`
  const ICON_SVGS: Record<string, string> = {
    // --- ICONOS B√ÅSICOS --- //
    api: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 13h5v-2H4v2zm11-6h5v2h-5V7zm0 4h5v2h-5v-2zm0 4h5v2h-5v-2z"/><path d="M8 7l4-4 4 4M12 3v10"/></svg>`,
    cloud: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17.5 17h-11a4.5 4.5 0 1 1 1.3-8.8A6 6 0 0 1 18 10a4 4 0 1 1-.5 7z"/></svg>`,
    code: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg>`,
    code2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg>`,
    database: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v6c0 1.7 4 3 9 3s9-1.3 9-3V5"/><path d="M3 11v6c0 1.7 4 3 9 3s9-1.3 9-3v-6"/></svg>`,
    mobile: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="7" y="2" width="10" height="20" rx="2"/><circle cx="12" cy="18" r="1"/></svg>`,
    lightning: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`,
    cpu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M9 1v3M15 1v3M9 20v3M15 20v3M1 9h3M1 15h3M20 9h3M20 15h3"/></svg>`,
    wifi: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12.5a10 10 0 0 1 14 0M8.5 15a5 5 0 0 1 7 0"/><circle cx="12" cy="18" r="1"/></svg>`,

    // --- SERVICIOS ESPEC√çFICOS --- //
    layers: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>`,
    layers2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>`,
    server: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><path d="M6 6h.01M6 18h.01"/></svg>`,
    eye: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg>`,
    zap: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`,
    robot: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4M8 16h.01M16 16h.01"/></svg>`,
    docker: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="5" y="9" width="3" height="3"/><rect x="9" y="9" width="3" height="3"/><rect x="13" y="9" width="3" height="3"/><rect x="9" y="5" width="3" height="3"/><path d="M2 13h20"/></svg>`,
    box: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/></svg>`,
    broadcast: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49M7.76 16.24a6 6 0 0 1 0-8.49M19.07 4.93a10 10 0 0 1 0 14.14M4.93 19.07a10 10 0 0 1 0-14.14"/></svg>`,
    smartphone: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2"/><path d="M12 18h.01"/></svg>`,
    users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
    activity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
    gauge: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/><circle cx="12" cy="12" r="3"/></svg>`,
    shield: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
    table: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18"/></svg>`,
    checkcircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>`,
    scan: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2M7 12h10"/></svg>`,
    linechart: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>`,
    bell: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0"/></svg>`,
    folder: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>`,
    lock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
    barchart2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>`,
    creditcard: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>`,
    repeat: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 1l4 4-4 4M3 11V9a4 4 0 0 1 4-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 0 1-4 4H3"/></svg>`,
    rocket: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>`,
    sparkles: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3zM5 3v4M3 5h4M19 17v4M17 19h4"/></svg>`,
  };

  function getLucideSvg(iconString: string | undefined | null): string | null {
    const name = normalizeIconName(iconString);
    if (!name) return null;
    const svg = ICON_SVGS[name]; // ahora TS sabe que ICON_SVGS acepta cualquier string
    if (svg) return svg;
    // fallback: c√≠rculo con iniciales
    const initials =
      name
        .split("-")
        .map((p) => p[0] || "")
        .join("")
        .slice(0, 2)
        .toUpperCase() || "SV";
    return `<div style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:999px;background:#eef2ff;color:#312e81;font-weight:600;font-size:12px">${initials}</div>`;
  }

  async function loadServices() {
    const container = document.getElementById("services-container");
    if (!container) return;

    try {
      // `${backendUrl}/api/v1/services`
      const response = await fetch("./services.json", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      });
      if (!response.ok) throw new Error("Failed to load services");

      const services: Service[] = await response.json();
      const activeServices = services.filter((service) => service.is_active);

      const html = activeServices
        .map(
          (service, index) => `
        <article class="service-card bg-white dark:bg-[#1a1a1a] rounded-2xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 dark:border-gray-800 group" style="animation-delay: ${index * 50}ms;">
          <div class="p-6 md:p-8">
            <div class="flex items-start gap-4 mb-6">
              <div class="flex h-16 w-16 flex-shrink-0 items-center justify-center rounded-xl bg-gradient-to-br from-primary to-purple-600 text-white shadow-lg group-hover:scale-110 transition-transform duration-300">
                ${getLucideSvg(service.icon) || "üöÄ"}
              </div>
              <div class="flex-1">
                <h3 class="font-bold text-xl md:text-2xl text-gray-900 dark:text-white hover:text-transparent hover:bg-clip-text hover:bg-gradient-to-r hover:from-primary hover:to-purple-600 transition-all" style="font-family: 'Inter Tight', system-ui, sans-serif;">${service.name}</h3>
              </div>
            </div>
            <p class="text-sm md:text-base text-gray-600 dark:text-gray-400 mb-6 leading-relaxed">${service.description}</p>
            ${service.price || service.duration ? `
              <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                ${service.price ? `<span class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-purple-600 font-bold text-lg">$${service.price}+</span>` : ''}
                ${service.duration ? `<span class="text-sm text-gray-500 dark:text-gray-400 font-medium">${service.duration}</span>` : ''}
              </div>
            ` : ''}
          </div>
        </article>
      `
        )
        .join("");

      container.innerHTML = html;

      // Trigger animation
      setTimeout(() => {
        document.querySelectorAll('.service-card').forEach((card, index) => {
          setTimeout(() => {
            card.classList.add('fade-in-up');
          }, index * 50);
        });
      }, 10);
    } catch (error) {
      console.error("Error loading services:", error);
      container.innerHTML = `
        <div class="rounded-lg bg-white dark:bg-[#1a1a2e] p-6 shadow-sm col-span-full md:col-span-1">
          <div class="flex items-start gap-4 mb-4">
            <div class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-primary/10 dark:bg-primary/20 text-primary text-2xl">
              ${getLucideSvg("LuServer") || "üåê"}
            </div>
            <div class="flex-1">
              <h3 class="font-bold text-lg text-gray-900 dark:text-white">Desarrollo Web Full Stack</h3>
            </div>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Desarrollo de aplicaciones web modernas y escalables con React, Astro y Python/FastAPI.</p>
          <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
            <span class="text-primary font-bold">$1500+</span>
            <span class="text-sm text-gray-500 dark:text-gray-400">2-4 semanas</span>
          </div>
        </div>
        <div class="rounded-lg bg-white dark:bg-[#1a1a2e] p-6 shadow-sm col-span-full md:col-span-1">
          <div class="flex items-start gap-4 mb-4">
            <div class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-primary/10 dark:bg-primary/20 text-primary text-2xl">
              ${getLucideSvg("LuRobot") || "ü§ñ"}
            </div>
            <div class="flex-1">
              <h3 class="font-bold text-lg text-gray-900 dark:text-white">Integraci√≥n de IA</h3>
            </div>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Implementaci√≥n de chatbots con LangChain, OpenAI y soluciones de IA personalizadas.</p>
          <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
            <span class="text-primary font-bold">$2000+</span>
            <span class="text-sm text-gray-500 dark:text-gray-400">3-6 semanas</span>
          </div>
        </div>
      `;
    }
  }

  document.addEventListener("DOMContentLoaded", loadServices);
</script>

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in-up {
    animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .hero-content {
    animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .service-card {
    opacity: 0;
    transform: translateY(30px);
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 12px;
  }

  ::-webkit-scrollbar-track {
    background: #F8F8F8;
  }

  :root.dark ::-webkit-scrollbar-track {
    background: #0a0a0a;
  }

  ::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, var(--primary-color), #9333ea);
    border-radius: 6px;
    border: 2px solid #F8F8F8;
  }

  :root.dark ::-webkit-scrollbar-thumb {
    border-color: #0a0a0a;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #9333ea, var(--primary-color));
  }

  #services-container {
    animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) 0.4s backwards;
  }
</style>
