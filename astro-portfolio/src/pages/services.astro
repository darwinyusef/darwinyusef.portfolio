---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import { getCollection } from "astro:content";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const servicesFromContent = await getCollection("services");
---

<Layout title={t("services.title")}>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <div class="min-h-screen bg-[#0a0a0a]">
    <Header />

    <main class="overflow-hidden px-5">
      <!-- Hero Section con Ultra Large Text -->
      <section class="relative min-h-[70vh] flex items-center justify-center py-20">
        <div class="max-w-[1800px] mx-auto w-full">
          <div class="text-center">
            <h1 class="text-[clamp(3rem,12vw,12rem)] font-black leading-[0.9] tracking-tighter  mb-8" style="font-family: 'Inter Tight', system-ui, sans-serif;">
              {lang === 'es' ? 'MIS' : lang === 'en' ? 'MY' : 'MEUS'}
              <br />
              <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary via-purple-600 to-pink-600">
                {lang === 'es' ? 'SERVICIOS' : lang === 'en' ? 'SERVICES' : 'SERVI√áOS'}
              </span>
            </h1>
            <p class="text-xl md:text-2xl text-gray-400 max-w-3xl mx-auto leading-relaxed" style="font-family: 'Inter Tight', system-ui, sans-serif;">
              {lang === 'es'
                ? 'Servicios profesionales de desarrollo y tecnolog√≠a para impulsar tu negocio.'
                : lang === 'en'
                ? 'Professional development and technology services to boost your business.'
                : 'Servi√ßos profissionais de desenvolvimento e tecnologia para impulsionar seu neg√≥cio.'}
            </p>
          </div>
        </div>
      </section>

      <section class="pb-16 max-w-7xl mx-auto relative z-10">
      <div
        id="services-container"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
      >
        <div class="text-center py-8 col-span-full">
          <p class="text-gray-400">Cargando servicios...</p>
        </div>
      </div>
      </section>
    </main>

    <!-- Modal de IA para chat de servicios -->
    <div id="ai-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="ai-modal-content bg-[#1a1a1a] rounded-3xl  max-w-3xl w-full h-[85vh] flex flex-col border border-gray-800">
        <!-- Header -->
        <div class="bg-[#1a1a1a] border-b border-gray-800 p-6 flex items-center justify-between flex-shrink-0">
          <div class="flex items-center gap-3">
            <span class="text-5xl" id="ai-modal-emoji">ü§ñ</span>
            <div>
              <h3 class="text-xl font-bold " id="ai-modal-title">Asistente de IA</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400" id="ai-modal-subtitle">Preg√∫ntame sobre este servicio</p>
            </div>
          </div>
          <button id="close-ai-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
            <span class="material-symbols-outlined text-white text-3xl">close</span>
          </button>
        </div>

        <!-- Chat Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4">
          <!-- Messages will be added here dynamically -->
        </div>

        <!-- Input Area -->
        <div class="border-t border-gray-800 p-4 bg-[#1a1a1a] flex-shrink-0">
          <form id="chat-form" class="flex gap-3">
            <input
              type="text"
              id="chat-input"
              placeholder="Escribe tu pregunta..."
              class="flex-1 px-4 py-3 bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary "
              autocomplete="off"
            />
            <button
              type="submit"
              id="send-btn"
              class="px-6 py-3 bg-gradient-to-r from-primary to-purple-600  rounded-xl font-semibold hover:shadow-lg transition-all duration-300 hover:scale-105 active:scale-95 flex items-center gap-2"
            >
              <span class="material-symbols-outlined">send</span>
              <span class="hidden sm:inline">Enviar</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const backendUrl = "http://localhost:8000";

  interface Service {
    id: number;
    name: string;
    description: string;
    price?: number;
    duration?: string;
    is_active: boolean;
    icon?: string;
  }

  function normalizeIconName(
    iconString: string | undefined | null
  ): string | null {
    if (!iconString) return null;
    // quitar prefijo Lu/lu si existe
    let s = iconString.replace(/^Lu|^lu/, "");
    // PascalCase -> kebab-case
    s = s
      .replace(/([a-z0-9])([A-Z])/g, "$1-$2")
      .replace(/([A-Z])([A-Z][a-z])/g, "$1-$2")
      .replace(/_/g, "-")
      .toLowerCase();
    return s;
  }

  // Tipado expl√≠cito para evitar problemas con `ICON_SVGS[name]`
  const ICON_SVGS: Record<string, string> = {
    // --- ICONOS B√ÅSICOS --- //
    api: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 13h5v-2H4v2zm11-6h5v2h-5V7zm0 4h5v2h-5v-2zm0 4h5v2h-5v-2z"/><path d="M8 7l4-4 4 4M12 3v10"/></svg>`,
    cloud: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17.5 17h-11a4.5 4.5 0 1 1 1.3-8.8A6 6 0 0 1 18 10a4 4 0 1 1-.5 7z"/></svg>`,
    code: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg>`,
    code2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg>`,
    database: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v6c0 1.7 4 3 9 3s9-1.3 9-3V5"/><path d="M3 11v6c0 1.7 4 3 9 3s9-1.3 9-3v-6"/></svg>`,
    mobile: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="7" y="2" width="10" height="20" rx="2"/><circle cx="12" cy="18" r="1"/></svg>`,
    lightning: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`,
    cpu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M9 1v3M15 1v3M9 20v3M15 20v3M1 9h3M1 15h3M20 9h3M20 15h3"/></svg>`,
    wifi: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12.5a10 10 0 0 1 14 0M8.5 15a5 5 0 0 1 7 0"/><circle cx="12" cy="18" r="1"/></svg>`,

    // --- SERVICIOS ESPEC√çFICOS --- //
    layers: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>`,
    layers2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>`,
    server: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><path d="M6 6h.01M6 18h.01"/></svg>`,
    eye: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg>`,
    zap: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`,
    robot: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4M8 16h.01M16 16h.01"/></svg>`,
    docker: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="5" y="9" width="3" height="3"/><rect x="9" y="9" width="3" height="3"/><rect x="13" y="9" width="3" height="3"/><rect x="9" y="5" width="3" height="3"/><path d="M2 13h20"/></svg>`,
    box: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/></svg>`,
    broadcast: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49M7.76 16.24a6 6 0 0 1 0-8.49M19.07 4.93a10 10 0 0 1 0 14.14M4.93 19.07a10 10 0 0 1 0-14.14"/></svg>`,
    smartphone: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2"/><path d="M12 18h.01"/></svg>`,
    users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
    activity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
    gauge: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/><circle cx="12" cy="12" r="3"/></svg>`,
    shield: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
    table: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18"/></svg>`,
    checkcircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>`,
    scan: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2M7 12h10"/></svg>`,
    linechart: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>`,
    bell: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0"/></svg>`,
    folder: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>`,
    lock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
    barchart2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>`,
    creditcard: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>`,
    repeat: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 1l4 4-4 4M3 11V9a4 4 0 0 1 4-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 0 1-4 4H3"/></svg>`,
    rocket: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>`,
    sparkles: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3zM5 3v4M3 5h4M19 17v4M17 19h4"/></svg>`,
  };

  function getLucideSvg(iconString: string | undefined | null): string | null {
    const name = normalizeIconName(iconString);
    if (!name) return null;
    const svg = ICON_SVGS[name]; // ahora TS sabe que ICON_SVGS acepta cualquier string
    if (svg) return svg;
    // fallback: c√≠rculo con iniciales
    const initials =
      name
        .split("-")
        .map((p) => p[0] || "")
        .join("")
        .slice(0, 2)
        .toUpperCase() || "SV";
    return `<div style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:999px;background:#eef2ff;color:#312e81;font-weight:600;font-size:12px">${initials}</div>`;
  }

  async function loadServices() {
    const container = document.getElementById("services-container");
    if (!container) return;

    try {
      console.log('üîÑ Cargando servicios...');
      // Cargar desde el archivo local en public/
      const response = await fetch("/services.json", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      });

      console.log('üì° Respuesta recibida:', response.status, response.statusText);

      if (!response.ok) throw new Error(`Failed to load services: ${response.status} ${response.statusText}`);

      const services: Service[] = await response.json();
      console.log(`üì¶ Servicios cargados: ${services.length} servicios en total`);

      const activeServices = services.filter((service) => service.is_active);
      console.log(`‚úÖ Servicios activos: ${activeServices.length}`);

      const html = activeServices
        .map(
          (service, index) => `
        <article class="service-card bg-[#1a1a1a] rounded-2xl shadow-xl overflow-hidden transition-all duration-500 hover:-translate-y-2 border border-gray-800 group" style="animation-delay: ${index * 50}ms;">
          <div class="p-6 md:p-8">
            <div class="flex items-start gap-4 mb-6">
              <div class="flex h-16 w-16 flex-shrink-0 items-center justify-center rounded-xl bg-gradient-to-br from-primary to-purple-600 text-white shadow-lg group-hover:scale-110 transition-transform duration-300">
                ${getLucideSvg(service.icon) || "üöÄ"}
              </div>
              <div class="flex-1">
                <h3 class="font-bold text-xl md:text-2xl  hover:text-transparent hover:bg-clip-text hover:bg-gradient-to-r hover:from-primary hover:to-purple-600 transition-all" style="font-family: 'Inter Tight', system-ui, sans-serif;">${service.name}</h3>
              </div>
            </div>
            <p class="text-sm md:text-base text-gray-400 mb-6 leading-relaxed">${service.description}</p>
            <div class="pt-4 border-t border-gray-700">
              <button
                class="ask-ai-btn w-full py-3 px-4 bg-gradient-to-r from-primary to-purple-600  rounded-xl font-semibold hover:shadow-lg transition-all duration-300 hover:scale-105 active:scale-95 flex items-center justify-center gap-2"
                data-service-name="${service.name}"
                data-service-description="${service.description}"
              >
                <span class="material-symbols-outlined text-white text-xl">psychology</span>
                <span>Preguntar a IA</span>
              </button>
            </div>
          </div>
        </article>
      `
        )
        .join("");

      container.innerHTML = html;

      // Trigger animation
      setTimeout(() => {
        document.querySelectorAll('.service-card').forEach((card, index) => {
          setTimeout(() => {
            card.classList.add('fade-in-up');
          }, index * 50);
        });
      }, 10);

      // IMPORTANTE: Inicializar event listeners DESPU√âS de insertar el HTML
      attachAIButtonListeners();
    } catch (error) {
      console.error("‚ùå Error loading services:", error);
      console.error("‚ùå Error details:", error instanceof Error ? error.message : String(error));
      container.innerHTML = `
        <div class="rounded-lg bg-[#1a1a2e] p-6 shadow-sm col-span-full md:col-span-1">
          <div class="flex items-start gap-4 mb-4">
            <div class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-primary/10 dark:bg-primary/20 text-primary text-2xl">
              ${getLucideSvg("LuServer") || "üåê"}
            </div>
            <div class="flex-1">
              <h3 class="font-bold text-lg ">Desarrollo Web Full Stack</h3>
            </div>
          </div>
          <p class="text-sm text-gray-400 mb-4">Desarrollo de aplicaciones web modernas y escalables con React, Astro y Python/FastAPI.</p>
          <div class="flex items-center justify-between pt-4 border-t border-gray-700">
            <span class="text-primary font-bold">$1500+</span>
            <span class="text-sm text-gray-500 dark:text-gray-400">2-4 semanas</span>
          </div>
        </div>
        <div class="rounded-lg bg-[#1a1a2e] p-6 shadow-sm col-span-full md:col-span-1">
          <div class="flex items-start gap-4 mb-4">
            <div class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-primary/10 dark:bg-primary/20 text-primary text-2xl">
              ${getLucideSvg("LuRobot") || "ü§ñ"}
            </div>
            <div class="flex-1">
              <h3 class="font-bold text-lg ">Integraci√≥n de IA</h3>
            </div>
          </div>
          <p class="text-sm text-gray-400 mb-4">Implementaci√≥n de chatbots con LangChain, OpenAI y soluciones de IA personalizadas.</p>
          <div class="flex items-center justify-between pt-4 border-t border-gray-700">
            <span class="text-primary font-bold">$2000+</span>
            <span class="text-sm text-gray-500 dark:text-gray-400">3-6 semanas</span>
          </div>
        </div>
      `;
    }
  }

  // Variables globales para el chat de IA
  const modal = document.getElementById('ai-modal');
  const closeBtn = document.getElementById('close-ai-modal');
  const chatMessages = document.getElementById('chat-messages');
  const chatForm = document.getElementById('chat-form') as HTMLFormElement;
  const chatInput = document.getElementById('chat-input') as HTMLInputElement;
  const sendBtn = document.getElementById('send-btn');
  const modalEmoji = document.getElementById('ai-modal-emoji');
  const modalTitle = document.getElementById('ai-modal-title');
  const modalSubtitle = document.getElementById('ai-modal-subtitle');

  // Variables para mantener el contexto
  let conversationHistory: Array<{role: string, content: string}> = [];
  let currentService = { name: '', description: '' };
  let isWaitingForResponse = false;

  // Emojis relacionados con servicios
  const serviceEmojis: Record<string, string> = {
    'desarrollo': 'üíª',
    'web': 'üåê',
    'm√≥vil': 'üì±',
    'mobile': 'üì±',
    'ia': 'ü§ñ',
    'inteligencia': 'üß†',
    'api': 'üîå',
    'backend': '‚öôÔ∏è',
    'frontend': 'üé®',
    'base de datos': 'üóÑÔ∏è',
    'database': 'üóÑÔ∏è',
    'cloud': '‚òÅÔ∏è',
    'nube': '‚òÅÔ∏è',
    'seguridad': 'üîí',
    'security': 'üîí',
    'devops': 'üöÄ',
    'consultor√≠a': 'üíº',
    'consultancy': 'üíº',
    'automatizaci√≥n': '‚ö°',
    'automation': '‚ö°',
    'an√°lisis': 'üìä',
    'analytics': 'üìä',
    'arquitectura': 'üèóÔ∏è',
    'architecture': 'üèóÔ∏è',
    'togaf': 'üìê',
    'agile': '‚ö°',
    'scrum': 'üîÑ',
    'default': '‚ú®'
  };

  function getServiceEmoji(serviceName: string): string {
    const lowerName = serviceName.toLowerCase();
    for (const [key, emoji] of Object.entries(serviceEmojis)) {
      if (lowerName.includes(key)) {
        return emoji;
      }
    }
    return serviceEmojis.default;
  }

  // Funci√≥n para adjuntar event listeners a los botones de IA
  function attachAIButtonListeners() {
    const aiButtons = document.querySelectorAll('.ask-ai-btn');
    console.log(`üîó Adjuntando listeners a ${aiButtons.length} botones de IA`);

    aiButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const serviceName = btn.getAttribute('data-service-name') || '';
        const serviceDescription = btn.getAttribute('data-service-description') || '';
        console.log(`üéØ Bot√≥n clickeado: ${serviceName}`);
        initializeChat(serviceName, serviceDescription);
      });
    });
  }

  // Funciones de utilidad del modal (ahora globales)
  function showModal() {
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  }

  function hideModal() {
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  }

  function clearChat() {
    if (chatMessages) {
      chatMessages.innerHTML = '';
    }
    conversationHistory = [];
  }

  function addMessage(content: string, role: 'user' | 'assistant' | 'system', isLoading = false) {
    if (!chatMessages) return;

      const messageDiv = document.createElement('div');
      messageDiv.className = `message-${role} ${isLoading ? 'message-loading' : ''}`;

      if (role === 'user') {
        messageDiv.innerHTML = `
          <div class="flex justify-end">
            <div class="max-w-[80%] bg-gradient-to-r from-primary to-purple-600  rounded-2xl rounded-tr-sm px-4 py-3 shadow-lg">
              <p class="text-sm leading-relaxed">${content}</p>
            </div>
          </div>
        `;
      } else if (role === 'assistant') {
        const emoji = getServiceEmoji(currentService.name);
        messageDiv.innerHTML = `
          <div class="flex gap-3">
            <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-2xl">
              ${emoji}
            </div>
            <div class="flex-1 bg-gray-100 dark:bg-gray-900 rounded-2xl rounded-tl-sm px-4 py-3 shadow">
              ${isLoading ? `
                <div class="flex items-center gap-2">
                  <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                  <span class="text-sm text-gray-500 dark:text-gray-400">Escribiendo...</span>
                </div>
              ` : `
                <div class="prose prose-sm dark:prose-invert max-w-none">
                  ${content}
                </div>
              `}
            </div>
          </div>
        `;
      } else if (role === 'system') {
        messageDiv.innerHTML = `
          <div class="flex justify-center">
            <div class="bg-gray-200 dark:bg-gray-800 rounded-full px-4 py-2 text-xs text-gray-400">
              ${content}
            </div>
          </div>
        `;
      }

      chatMessages.appendChild(messageDiv);

      // Scroll to bottom con animaci√≥n suave
      setTimeout(() => {
        chatMessages.scrollTo({
          top: chatMessages.scrollHeight,
          behavior: 'smooth'
        });
      }, 100);

      return messageDiv;
  }

  async function sendMessage(userMessage: string) {
    if (isWaitingForResponse || !userMessage.trim()) return;

    isWaitingForResponse = true;

    // Deshabilitar input y bot√≥n
    if (chatInput) chatInput.disabled = true;
    if (sendBtn) sendBtn.classList.add('opacity-50', 'cursor-not-allowed');

    // Agregar mensaje del usuario
    addMessage(userMessage, 'user');

    // Agregar mensaje de "escribiendo..."
    const loadingMessage = addMessage('', 'assistant', true);

    // Agregar al historial
    conversationHistory.push({
      role: 'user',
      content: userMessage
    });

    try {
      // Llamada a la API
      const response = await fetch('/api/ask-ai.json', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          serviceName: currentService.name,
          serviceDescription: currentService.description,
          conversationHistory: conversationHistory,
        }),
      });

      if (!response.ok) {
        throw new Error('Error al conectar con la IA');
      }

      const data = await response.json();

      if (data.error) {
        throw new Error(data.error);
      }

      // Remover mensaje de carga
      loadingMessage?.remove();

      // Agregar respuesta de la IA
      addMessage(data.response, 'assistant');

      // Agregar al historial
      conversationHistory.push({
        role: 'assistant',
        content: data.response
      });

    } catch (error) {
      console.error('Error al consultar IA:', error);
      loadingMessage?.remove();
      addMessage('‚ö†Ô∏è Lo siento, ocurri√≥ un error al procesar tu mensaje. Por favor intenta de nuevo.', 'assistant');
    } finally {
      isWaitingForResponse = false;
      if (chatInput) {
        chatInput.disabled = false;
        chatInput.focus();
      }
      if (sendBtn) sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }

  async function initializeChat(serviceName: string, serviceDescription: string) {
    currentService = { name: serviceName, description: serviceDescription };

    // Limpiar chat anterior
    clearChat();

    // Actualizar header
    const emoji = getServiceEmoji(serviceName);
    if (modalEmoji) modalEmoji.textContent = emoji;
    if (modalTitle) modalTitle.textContent = serviceName;
    if (modalSubtitle) modalSubtitle.textContent = 'Preg√∫ntame lo que necesites saber';

    // Mostrar modal
    showModal();

    // Mensaje de bienvenida
    addMessage(`¬°Hola! üëã Soy tu asistente de IA para ${serviceName}`, 'system');

    // Enviar primera pregunta autom√°ticamente
    isWaitingForResponse = true;
    const loadingMessage = addMessage('', 'assistant', true);

    conversationHistory = [{
      role: 'system',
      content: `Eres un experto en tecnolog√≠a y desarrollo de software. El usuario est√° interesado en: ${serviceName}. Descripci√≥n: ${serviceDescription}`
    }];

    try {
      const response = await fetch('/api/ask-ai.json', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          serviceName,
          serviceDescription,
          conversationHistory: conversationHistory,
          isInitialMessage: true,
        }),
      });

      if (!response.ok) throw new Error('Error al conectar con la IA');

      const data = await response.json();

      if (data.error) throw new Error(data.error);

      loadingMessage?.remove();
      addMessage(data.response, 'assistant');

      conversationHistory.push({
        role: 'assistant',
        content: data.response
      });

    } catch (error) {
      console.error('Error:', error);
      loadingMessage?.remove();
      addMessage('‚ö†Ô∏è Error al iniciar la conversaci√≥n', 'assistant');
    } finally {
      isWaitingForResponse = false;
      if (chatInput) chatInput.focus();
    }
  }

  // Funci√≥n para inicializar event listeners del modal (solo se llama una vez)
  function initAIChat() {
    // Event listeners para el modal y el formulario (NO para los botones de servicio)
    chatForm?.addEventListener('submit', (e) => {
      e.preventDefault();
      if (chatInput && chatInput.value.trim()) {
        sendMessage(chatInput.value.trim());
        chatInput.value = '';
      }
    });

    closeBtn?.addEventListener('click', hideModal);

    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        hideModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal?.classList.contains('hidden')) {
        hideModal();
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Inicializar event listeners del modal
    initAIChat();

    // Cargar servicios y adjuntar event listeners a los botones
    loadServices().then(() => {
      console.log('‚úÖ Servicios cargados correctamente');
    });
  });
</script>

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in-up {
    animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .hero-content {
    animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .service-card {
    opacity: 0;
    transform: translateY(30px);
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 12px;
  }

  ::-webkit-scrollbar-track {
    background: #F8F8F8;
  }

  :root.dark ::-webkit-scrollbar-track {
    background: #0a0a0a;
  }

  ::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, var(--primary-color), #9333ea);
    border-radius: 6px;
    border: 2px solid #F8F8F8;
  }

  :root.dark ::-webkit-scrollbar-thumb {
    border-color: #0a0a0a;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #9333ea, var(--primary-color));
  }

  #services-container {
    animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) 0.4s backwards;
  }

  /* AI Modal Animations */
  #ai-modal:not(.hidden) {
    animation: fadeIn 0.3s ease-out;
  }

  #ai-modal:not(.hidden) .ai-modal-content {
    animation: modalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* Smooth scrolling for modal content */
  .ai-modal-content {
    scroll-behavior: smooth;
  }

  /* Custom prose styles for AI response */
  .prose p {
    margin-bottom: 1rem;
  }

  .prose ul {
    margin-top: 0.5rem;
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-bottom: 0.5rem;
  }

  /* Ask AI button hover effect */
  .ask-ai-btn {
    position: relative;
    overflow: hidden;
  }

  .ask-ai-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }

  .ask-ai-btn:hover::before {
    width: 300px;
    height: 300px;
  }

  /* Chat Messages Styling */
  #chat-messages {
    scroll-behavior: smooth;
  }

  #chat-messages::-webkit-scrollbar {
    width: 6px;
  }

  #chat-messages::-webkit-scrollbar-track {
    background: transparent;
  }

  #chat-messages::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }

  :root.dark #chat-messages::-webkit-scrollbar-thumb {
    background: #475569;
  }

  /* Message animations */
  .message-user,
  .message-assistant,
  .message-system {
    animation: messageSlideIn 0.3s ease-out;
  }

  @keyframes messageSlideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #9333ea;
    animation: typingDot 1.4s infinite;
  }

  .typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
  }

  .typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typingDot {
    0%, 60%, 100% {
      transform: translateY(0);
      opacity: 0.4;
    }
    30% {
      transform: translateY(-10px);
      opacity: 1;
    }
  }

  /* Prose styles for chat messages */
  .prose.prose-sm p {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .prose.prose-sm p:first-child {
    margin-top: 0;
  }

  .prose.prose-sm p:last-child {
    margin-bottom: 0;
  }

  .prose.prose-sm ul,
  .prose.prose-sm ol {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
    padding-left: 1.25rem;
  }

  .prose.prose-sm li {
    margin-top: 0.25rem;
    margin-bottom: 0.25rem;
  }

  /* Strong solo en mensajes de IA del chat */
  #chat-messages .message-assistant .prose.prose-sm strong {
    background: linear-gradient(to right, var(--primary-color), #9333ea);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
  }

  /* Strong normal en otros contextos */
  .prose.prose-sm strong {
    color: inherit;
    font-weight: 600;
  }

  /* Enlaces en respuestas de IA */
  .prose.prose-sm a {
    color: #7c3aed;
    font-weight: 600;
    text-decoration: none;
    background: linear-gradient(to right, rgba(124, 58, 237, 0.1), rgba(147, 51, 234, 0.1));
    padding: 2px 8px;
    border-radius: 6px;
    border: 1px solid rgba(124, 58, 237, 0.3);
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .prose.prose-sm a:hover {
    background: linear-gradient(to right, rgba(124, 58, 237, 0.2), rgba(147, 51, 234, 0.2));
    border-color: rgba(124, 58, 237, 0.5);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.2);
  }

  .prose.prose-sm a::after {
    content: '‚Üí';
    font-size: 0.9em;
    opacity: 0.7;
  }

  :root.dark .prose.prose-sm a {
    color: #a78bfa;
    background: linear-gradient(to right, rgba(167, 139, 250, 0.15), rgba(196, 181, 253, 0.15));
    border-color: rgba(167, 139, 250, 0.4);
  }

  :root.dark .prose.prose-sm a:hover {
    background: linear-gradient(to right, rgba(167, 139, 250, 0.25), rgba(196, 181, 253, 0.25));
    border-color: rgba(167, 139, 250, 0.6);
    box-shadow: 0 2px 8px rgba(167, 139, 250, 0.3);
  }

  /* Input focus */
  #chat-input:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  /* Send button disabled state */
  #send-btn.opacity-50 {
    pointer-events: none;
  }
</style>
