---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import { getCollection } from "astro:content";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const podcastsFromContent = await getCollection("podcasts", ({ data }) => data.is_active);
---

<Layout title={t("podcast.title")}>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <div class="min-h-screen bg-[#F8F8F8] dark:bg-[#0a0a0a]">
    <Header />

    <main class="overflow-hidden px-5">
      <!-- Hero Section con Ultra Large Text -->
      <section class="relative min-h-[70vh] flex items-center justify-center py-20">
        <div class="max-w-[1800px] mx-auto w-full">
          <div class="text-center">
            <h1 class="text-[clamp(3rem,12vw,12rem)] font-black leading-[0.9] tracking-tighter text-gray-900 dark:text-white mb-8" style="font-family: 'Inter Tight', system-ui, sans-serif;">
              {lang === 'es' ? 'MI' : lang === 'en' ? 'MY' : 'MEU'}
              <br />
              <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary via-purple-600 to-pink-600">
                PODCAST
              </span>
            </h1>
            <p class="text-xl md:text-2xl text-gray-600 dark:text-gray-400 max-w-3xl mx-auto leading-relaxed" style="font-family: 'Inter Tight', system-ui, sans-serif;">
              {lang === 'es'
                ? 'Conversaciones sobre tecnología, desarrollo y experiencias en el mundo tech.'
                : lang === 'en'
                ? 'Conversations about technology, development and experiences in the tech world.'
                : 'Conversas sobre tecnologia, desenvolvimento e experiências no mundo tech.'}
            </p>
          </div>
        </div>
      </section>

      <section class="pb-16 max-w-5xl mx-auto relative z-10">
      <div id="podcast-container" class="space-y-8">
        {
          podcastsFromContent.length > 0 ? (
            podcastsFromContent
              .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
              .map((podcast, index) => (
                <article class="podcast-card rounded-2xl bg-white dark:bg-[#1a1a1a] p-6 md:p-8 shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 dark:border-gray-800 group">
                  <div class="flex gap-6">
                    {podcast.data.coverImage ? (
                      <img
                        src={podcast.data.coverImage}
                        alt={podcast.data.title}
                        class="w-32 h-32 rounded-xl object-cover flex-shrink-0 shadow-lg group-hover:scale-105 transition-transform duration-300"
                      />
                    ) : (
                      <div class="w-32 h-32 rounded-xl bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center flex-shrink-0 shadow-lg group-hover:scale-105 transition-transform duration-300">
                        <span class="material-symbols-outlined text-5xl text-white">
                          podcast
                        </span>
                      </div>
                    )}
                    <div class="flex-1 min-w-0">
                      <h3 class="font-bold text-2xl md:text-3xl text-gray-900 dark:text-white mb-3 hover:text-transparent hover:bg-clip-text hover:bg-gradient-to-r hover:from-primary hover:to-purple-600 transition-all" style="font-family: 'Inter Tight', system-ui, sans-serif;">
                        {podcast.data.title}
                      </h3>
                      <p class="text-sm md:text-base text-gray-600 dark:text-gray-400 mb-4 line-clamp-2 leading-relaxed">
                        {podcast.data.description}
                      </p>
                      <div class="flex items-center gap-3 flex-wrap">
                        <a
                          href={`/${lang === "es" ? "" : lang}podcast/${podcast.slug}`}
                          class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-primary to-purple-600 text-white rounded-lg font-semibold transition-all duration-300 hover:shadow-lg hover:scale-105"
                        >
                          <span class="material-symbols-outlined text-sm">visibility</span>
                          <span class="text-sm">Ver episodio</span>
                        </a>
                        <button
                          class="play-podcast-btn inline-flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 rounded-lg font-semibold hover:bg-slate-200 dark:hover:bg-slate-700 transition-all duration-300 hover:scale-105"
                          data-audio={podcast.data.audioUrl}
                          data-title={podcast.data.title}
                        >
                          <span class="material-symbols-outlined text-sm">play_circle</span>
                          <span class="text-sm">Reproducir</span>
                        </button>
                        <span class="text-sm text-gray-500 dark:text-gray-400 font-medium flex items-center gap-1">
                          <span class="material-symbols-outlined text-sm">schedule</span>
                          {podcast.data.duration}
                        </span>
                      </div>
                    </div>
                  </div>
                </article>
              ))
          ) : (
            <div class="text-center py-8">
              <p class="text-gray-600 dark:text-gray-400">
                No hay episodios disponibles en este momento.
              </p>
            </div>
          )
        }
      </div>
      </section>
    </main>
  </div>

  <div
    id="audio-player"
    class="fixed bottom-0 left-0 right-0 bg-white dark:bg-[#1a1a2e] border-t border-gray-200 dark:border-gray-700 p-4 shadow-lg hidden"
  >
    <div class="max-w-4xl mx-auto flex items-center gap-4">
      <button
        id="play-pause-btn"
        class="flex h-10 w-10 items-center justify-center rounded-full bg-primary text-white hover:opacity-90"
      >
        <span class="material-symbols-outlined" id="play-pause-icon"
          >play_arrow</span
        >
      </button>

      <div class="flex-1">
        <div
          class="text-sm font-semibold text-gray-900 dark:text-white"
          id="current-title"
        >
          Título del episodio
        </div>
        <div class="flex items-center gap-2 mt-1">
          <span
            class="text-xs text-gray-500 dark:text-gray-400"
            id="current-time">0:00</span
          >
          <div
            class="flex-1 h-1 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden cursor-pointer"
            id="progress-bar"
          >
            <div class="h-1 bg-primary" id="progress" style="width: 0%"></div>
          </div>
          <span
            class="text-xs text-gray-500 dark:text-gray-400"
            id="duration-time">0:00</span
          >
        </div>
      </div>

      <button
        id="close-player-btn"
        class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
      >
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <audio id="audio-element" preload="metadata"></audio>
  </div>
</Layout>

<script>
  let currentAudio: HTMLAudioElement | null = null;
  let isPlaying = false;

  function formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, "0")}`;
  }

  function playPodcast(audioUrl: string, title: string) {
    const audioElement = document.getElementById(
      "audio-element"
    ) as HTMLAudioElement;
    const audioPlayer = document.getElementById("audio-player");
    const currentTitle = document.getElementById("current-title");
    const playPauseIcon = document.getElementById("play-pause-icon");

    if (!audioElement || !audioPlayer || !currentTitle || !playPauseIcon)
      return;

    if (currentAudio && currentAudio.src.includes(audioUrl)) {
      if (isPlaying) {
        audioElement.pause();
        playPauseIcon.textContent = "play_arrow";
        isPlaying = false;
      } else {
        audioElement.play();
        playPauseIcon.textContent = "pause";
        isPlaying = true;
      }
    } else {
      audioElement.src = audioUrl;
      currentTitle.textContent = title;
      audioElement.play();
      playPauseIcon.textContent = "pause";
      isPlaying = true;
      audioPlayer.classList.remove("hidden");
    }

    currentAudio = audioElement;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const audioElement = document.getElementById(
      "audio-element"
    ) as HTMLAudioElement;
    const playPauseBtn = document.getElementById("play-pause-btn");
    const playPauseIcon = document.getElementById("play-pause-icon");
    const closePlayerBtn = document.getElementById("close-player-btn");
    const progressBar = document.getElementById("progress-bar");
    const progress = document.getElementById("progress");
    const currentTime = document.getElementById("current-time");
    const durationTime = document.getElementById("duration-time");
    const audioPlayer = document.getElementById("audio-player");

    // Event listeners para los botones de reproducción
    document.querySelectorAll(".play-podcast-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const target = e.currentTarget as HTMLButtonElement;
        const audioUrl = target.dataset.audio || "";
        const title = target.dataset.title || "";
        console.log('Playing podcast:', title, audioUrl);
        playPodcast(audioUrl, title);
      });
    });

    // Trigger animations después de registrar los event listeners
    setTimeout(() => {
      document.querySelectorAll('.podcast-card').forEach((card, index) => {
        setTimeout(() => {
          card.classList.add('fade-in-up');
        }, index * 100);
      });
    }, 10);

    if (
      audioElement &&
      playPauseBtn &&
      playPauseIcon &&
      closePlayerBtn &&
      progressBar &&
      progress &&
      currentTime &&
      durationTime &&
      audioPlayer
    ) {
      playPauseBtn.addEventListener("click", () => {
        if (isPlaying) {
          audioElement.pause();
          playPauseIcon.textContent = "play_arrow";
          isPlaying = false;
        } else {
          audioElement.play();
          playPauseIcon.textContent = "pause";
          isPlaying = true;
        }
      });

      closePlayerBtn.addEventListener("click", () => {
        audioElement.pause();
        audioElement.src = "";
        audioPlayer.classList.add("hidden");
        isPlaying = false;
        playPauseIcon.textContent = "play_arrow";
      });

      audioElement.addEventListener("timeupdate", () => {
        const percent =
          (audioElement.currentTime / audioElement.duration) * 100;
        progress.style.width = `${percent}%`;
        currentTime.textContent = formatTime(audioElement.currentTime);
      });

      audioElement.addEventListener("loadedmetadata", () => {
        durationTime.textContent = formatTime(audioElement.duration);
      });

      progressBar.addEventListener("click", (e) => {
        const rect = progressBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        audioElement.currentTime = percent * audioElement.duration;
      });
    }
  });
</script>

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in-up {
    animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .hero-content {
    animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .podcast-card {
    opacity: 0;
    transform: translateY(30px);
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 12px;
  }

  ::-webkit-scrollbar-track {
    background: #F8F8F8;
  }

  :root.dark ::-webkit-scrollbar-track {
    background: #0a0a0a;
  }

  ::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, var(--primary-color), #9333ea);
    border-radius: 6px;
    border: 2px solid #F8F8F8;
  }

  :root.dark ::-webkit-scrollbar-thumb {
    border-color: #0a0a0a;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #9333ea, var(--primary-color));
  }

  #podcast-container {
    animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) 0.4s backwards;
  }
</style>
