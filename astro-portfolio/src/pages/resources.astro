---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<Layout title="Recursos">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <div class="min-h-screen bg-[#F8F8F8] dark:bg-[#0a0a0a]">
    <Header />

    <main class="overflow-hidden px-5">
      <section class="relative min-h-[70vh] flex items-center justify-center py-20">
        <div class="max-w-[1800px] mx-auto w-full">
          <div class="text-center">
            <h1 class="text-[clamp(3rem,12vw,12rem)] font-black leading-[0.9] tracking-tighter text-gray-900 dark:text-white mb-8" style="font-family: 'Inter Tight', system-ui, sans-serif;">
              {lang === 'es' ? 'MIS' : lang === 'en' ? 'MY' : 'MEUS'}
              <br />
              <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary via-purple-600 to-pink-600">
                {lang === 'es' ? 'RECURSOS' : lang === 'en' ? 'RESOURCES' : 'RECURSOS'}
              </span>
            </h1>
            <p class="text-xl md:text-2xl text-gray-600 dark:text-gray-400 max-w-3xl mx-auto leading-relaxed" style="font-family: 'Inter Tight', system-ui, sans-serif;">
              {lang === 'es'
                ? 'Herramientas, guías y materiales útiles para desarrolladores.'
                : lang === 'en'
                ? 'Tools, guides and useful materials for developers.'
                : 'Ferramentas, guias e materiais úteis para desenvolvedores.'}
            </p>
          </div>
        </div>
      </section>

      <section class="pb-16 max-w-7xl mx-auto relative z-10">
      <!-- Filtros con glassmorphism -->
      <div class="bg-white/80 dark:bg-[#1a1a1a]/80 backdrop-blur-xl rounded-2xl shadow-2xl p-6 md:p-8 mb-8 border border-gray-100 dark:border-gray-800 filter-card">
        <!-- Filtro de categorías -->
        <div class="mb-6">
          <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 tracking-wide uppercase" style="font-family: 'Inter Tight', system-ui, sans-serif;">
            {lang === 'es' ? 'Categorías' : lang === 'en' ? 'Categories' : 'Categorias'}
          </h3>
          <div class="flex flex-wrap gap-2" id="category-filters">
            <button
              class="category-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-300 bg-gradient-to-r from-primary to-purple-600 text-white shadow-sm hover:shadow-md hover:scale-105"
              data-category="all"
            >
              {lang === 'es' ? 'Todos' : lang === 'en' ? 'All' : 'Todos'} <span class="category-count ml-1 text-xs opacity-90"></span>
            </button>
          </div>
        </div>

        <!-- Filtro de tipo -->
        <div>
          <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 tracking-wide uppercase" style="font-family: 'Inter Tight', system-ui, sans-serif;">
            {lang === 'es' ? 'Tipo de Recurso' : lang === 'en' ? 'Resource Type' : 'Tipo de Recurso'}
          </h3>
          <div class="flex flex-wrap gap-2" id="type-filters">
            <button
              class="type-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-300 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600 hover:scale-105"
              data-type="all"
            >
              {lang === 'es' ? 'Todos los tipos' : lang === 'en' ? 'All Types' : 'Todos os tipos'}
            </button>
          </div>
        </div>
      </div>

      <div id="resources-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <div class="col-span-full text-center py-8">
          <p class="text-gray-600 dark:text-gray-400">Cargando recursos...</p>
        </div>
      </div>
      </section>
    </main>
  </div>
</Layout>

<script>
  interface Resource {
    id: number;
    title: string;
    description: string;
    url: string;
    type: string;
    category: string;
    tags: string[];
    language: string;
    is_active: boolean;
  }

  let allResources: Resource[] = [];
  let currentCategory = 'all';
  let currentType = 'all';

  function createCategoryFilters(resources: Resource[]) {
    const categoriesMap = new Map<string, number>();

    resources.forEach(resource => {
      const category = resource.category || 'Sin categoría';
      categoriesMap.set(category, (categoriesMap.get(category) || 0) + 1);
    });

    const filtersContainer = document.getElementById('category-filters');
    if (!filtersContainer) return;

    const allBtn = filtersContainer.querySelector('[data-category="all"]');
    if (allBtn) {
      const countSpan = allBtn.querySelector('.category-count');
      if (countSpan) countSpan.textContent = `(${resources.length})`;
    }

    const categoryButtons = Array.from(categoriesMap.entries())
      .sort((a, b) => a[0].localeCompare(b[0]))
      .map(([category, count]) => {
        return `
          <button
            class="category-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-300 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-gradient-to-r hover:from-primary hover:to-purple-600 hover:text-white shadow-sm hover:scale-105"
            data-category="${category}"
          >
            ${category} <span class="ml-1 text-xs opacity-75">(${count})</span>
          </button>
        `;
      }).join('');

    if (allBtn) {
      allBtn.insertAdjacentHTML('afterend', categoryButtons);
    }

    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const category = btn.getAttribute('data-category');
        filterByCategory(category || 'all');
      });
    });
  }

  function createTypeFilters(resources: Resource[]) {
    const typesMap = new Map<string, number>();

    resources.forEach(resource => {
      const type = resource.type || 'Otro';
      typesMap.set(type, (typesMap.get(type) || 0) + 1);
    });

    const filtersContainer = document.getElementById('type-filters');
    if (!filtersContainer) return;

    const typeButtons = Array.from(typesMap.entries())
      .sort((a, b) => a[0].localeCompare(b[0]))
      .map(([type, count]) => {
        return `
          <button
            class="type-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-300 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"
            data-type="${type}"
          >
            ${type} <span class="text-xs opacity-75">(${count})</span>
          </button>
        `;
      }).join('');

    const allBtn = filtersContainer.querySelector('[data-type="all"]');
    if (allBtn) {
      allBtn.insertAdjacentHTML('afterend', typeButtons);
    }

    document.querySelectorAll('.type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const type = btn.getAttribute('data-type');
        filterByType(type || 'all');
      });
    });
  }

  function filterByCategory(category: string) {
    currentCategory = category;

    document.querySelectorAll('.category-btn').forEach(btn => {
      if (btn.getAttribute('data-category') === category) {
        btn.className = 'category-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-300 bg-gradient-to-r from-primary to-purple-600 text-white shadow-sm hover:shadow-md hover:scale-105';
      } else {
        btn.className = 'category-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-300 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-gradient-to-r hover:from-primary hover:to-purple-600 hover:text-white shadow-sm hover:scale-105';
      }
    });

    applyFilters();
  }

  function filterByType(type: string) {
    currentType = type;

    document.querySelectorAll('.type-btn').forEach(btn => {
      if (btn.getAttribute('data-type') === type) {
        btn.className = 'type-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-300 bg-gradient-to-r from-primary to-purple-600 text-white hover:scale-105';
      } else {
        btn.className = 'type-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-300 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600 hover:scale-105';
      }
    });

    applyFilters();
  }

  function applyFilters() {
    let filteredResources = allResources;

    if (currentCategory !== 'all') {
      filteredResources = filteredResources.filter(r => r.category === currentCategory);
    }

    if (currentType !== 'all') {
      filteredResources = filteredResources.filter(r => r.type === currentType);
    }

    renderResources(filteredResources);
  }

  function renderResources(resources: Resource[]) {
    const container = document.getElementById('resources-container');
    if (!container) return;

    if (resources.length === 0) {
      container.innerHTML = `
        <div class="col-span-full text-center py-16">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-r from-primary to-purple-600 mb-4">
            <span class="material-symbols-outlined text-white text-4xl">search_off</span>
          </div>
          <p class="text-gray-600 dark:text-gray-400 text-lg font-medium">No hay recursos con estos filtros.</p>
          <p class="text-gray-500 dark:text-gray-500 text-sm mt-2">Intenta seleccionar otros filtros</p>
        </div>
      `;
      return;
    }

    const html = resources.map((resource, index) => {
      const typeIcon = {
        'Documentación': 'description',
        'Curso': 'school',
        'Tutorial': 'play_lesson',
        'Certificación': 'workspace_premium',
      }[resource.type] || 'link';

      return `
        <article class="resource-card bg-white dark:bg-[#1a1a1a] rounded-2xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 hover:-translate-y-2 border border-gray-100 dark:border-gray-800 group" style="animation-delay: ${index * 50}ms;">
          <div class="p-6 md:p-8">
            <div class="flex items-start justify-between mb-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                  <span class="material-symbols-outlined text-white text-2xl">${typeIcon}</span>
                </div>
                <div>
                  <span class="inline-block bg-gradient-to-r from-primary/10 to-purple-600/10 text-primary text-xs font-bold px-3 py-1.5 rounded-full border border-primary/20">
                    ${resource.type}
                  </span>
                </div>
              </div>
            </div>

            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-3 hover:text-transparent hover:bg-clip-text hover:bg-gradient-to-r hover:from-primary hover:to-purple-600 transition-all line-clamp-2" style="font-family: 'Inter Tight', system-ui, sans-serif;">
              ${resource.title}
            </h3>

            <p class="text-sm text-gray-600 dark:text-gray-400 mb-6 line-clamp-3 leading-relaxed">${resource.description}</p>

            <div class="flex items-center gap-2 mb-5 flex-wrap">
              <span class="text-xs bg-slate-100 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 px-3 py-1.5 rounded-lg font-medium backdrop-blur-sm">
                ${resource.category}
              </span>
              <span class="text-xs bg-slate-100 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 px-3 py-1.5 rounded-lg flex items-center gap-1.5 font-medium backdrop-blur-sm">
                <span class="material-symbols-outlined text-xs">language</span>
                ${resource.language}
              </span>
            </div>

            ${resource.tags && resource.tags.length > 0 ? `
              <div class="flex flex-wrap gap-2 mb-6">
                ${resource.tags.slice(0, 4).map(tag => `
                  <span class="text-xs bg-gradient-to-r from-primary/5 to-purple-600/5 text-primary px-3 py-1 rounded-lg border border-primary/10 font-medium">
                    #${tag}
                  </span>
                `).join('')}
              </div>
            ` : ''}

            <a
              href="${resource.url}"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-primary to-purple-600 text-white rounded-lg font-semibold transition-all duration-300 hover:shadow-lg hover:gap-3 group/btn"
            >
              <span>Visitar recurso</span>
              <span class="material-symbols-outlined text-sm group-hover/btn:translate-x-1 transition-transform">open_in_new</span>
            </a>
          </div>
        </article>
      `;
    }).join('');

    container.innerHTML = html;

    // Trigger animation
    setTimeout(() => {
      document.querySelectorAll('.resource-card').forEach((card, index) => {
        setTimeout(() => {
          card.classList.add('fade-in-up');
        }, index * 50);
      });
    }, 10);
  }

  async function loadResources() {
    const container = document.getElementById('resources-container');
    if (!container) return;

    try {
      const response = await fetch('/recursos.json');
      if (!response.ok) throw new Error('Failed to load resources');

      const loadedResources: Resource[] = await response.json();
      allResources = loadedResources.filter(r => r.is_active);

      if (allResources.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-8">
            <p class="text-gray-600 dark:text-gray-400">No hay recursos disponibles.</p>
          </div>
        `;
        return;
      }

      createCategoryFilters(allResources);
      createTypeFilters(allResources);
      renderResources(allResources);

    } catch (error) {
      console.error('Error loading resources:', error);
      container.innerHTML = `
        <div class="col-span-full text-center py-8">
          <p class="text-red-500 dark:text-red-400">Error al cargar recursos.</p>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Por favor, intenta de nuevo más tarde.</p>
        </div>
      `;
    }
  }

  document.addEventListener('DOMContentLoaded', loadResources);
</script>

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in-up {
    animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .hero-content {
    animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .filter-card {
    animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
  }

  .resource-card {
    opacity: 0;
    transform: translateY(30px);
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 12px;
  }

  ::-webkit-scrollbar-track {
    background: #F8F8F8;
  }

  :root.dark ::-webkit-scrollbar-track {
    background: #0a0a0a;
  }

  ::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, var(--primary-color), #9333ea);
    border-radius: 6px;
    border: 2px solid #F8F8F8;
  }

  :root.dark ::-webkit-scrollbar-thumb {
    border-color: #0a0a0a;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #9333ea, var(--primary-color));
  }

  /* Smooth transitions */
  * {
    transition-property: background-color, border-color, color, fill, stroke;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 300ms;
  }

  /* Grid layout improvements */
  #resources-container {
    animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) 0.4s backwards;
  }
</style>
