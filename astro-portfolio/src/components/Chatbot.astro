---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<div id="chatbot-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
  <div class="bg-[#1a1a2e] rounded-lg  w-full max-w-2xl max-h-[80vh] flex flex-col">
    <div class="flex items-center justify-between p-4 border-b border-gray-700">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
          <span class="material-symbols-outlined text-white">smart_toy</span>
        </div>
        <div>
          <h3 class="font-bold ">{t('chatbot.title')}</h3>
          <p class="text-xs text-gray-400">Powered by OpenAI</p>
        </div>
      </div>
      <button id="close-chatbot-btn" class="text-gray-500 hover:text-gray-300">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
      <div class="flex gap-3">
        <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center flex-shrink-0">
          <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
        </div>
        <div class="flex-1">
          <div class="bg-gray-800 rounded-lg p-3">
            <p class="text-sm ">
              {lang === 'es' ? '¡Hola! Soy tu asistente virtual. ¿En qué puedo ayudarte hoy?' :
               lang === 'en' ? 'Hello! I\'m your virtual assistant. How can I help you today?' :
               'Olá! Sou seu assistente virtual. Como posso ajudá-lo hoje?'}
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="p-4 border-t border-gray-700">
      <form id="chat-form" class="flex gap-2">
        <input
          type="text"
          id="chat-input"
          placeholder={t('chatbot.placeholder')}
          class="flex-1 bg-gray-800 border-0 rounded-lg p-3 text-sm focus:ring-2 focus:ring-primary "
          required
        />
        <button
          type="submit"
          class="bg-primary  px-6 py-3 rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2 font-medium"
        >
          <span class="material-symbols-outlined">send</span>
          {t('chatbot.send')}
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  // Historial de conversación
  let conversationHistory: Array<{role: string, content: string}> = [];

  function addMessage(content: string, isUser: boolean) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex gap-3';

    if (isUser) {
      messageDiv.innerHTML = `
        <div class="flex-1"></div>
        <div class="flex-1 max-w-md">
          <div class="bg-primary  rounded-lg p-3 ml-auto">
            <p class="text-sm">${content}</p>
          </div>
        </div>
        <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center flex-shrink-0">
          <span class="material-symbols-outlined text-gray-300 text-sm">person</span>
        </div>
      `;
      // Agregar al historial
      conversationHistory.push({ role: 'user', content: content });
    } else {
      messageDiv.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center flex-shrink-0">
          <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
        </div>
        <div class="flex-1">
          <div class="bg-gray-800 rounded-lg p-3">
            <div class="text-sm  chatbot-response">${content}</div>
          </div>
        </div>
      `;
      // Agregar al historial
      conversationHistory.push({ role: 'assistant', content: content });
    }

    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function addLoadingMessage() {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;

    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'flex gap-3';
    loadingDiv.id = 'loading-message';
    loadingDiv.innerHTML = `
      <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center flex-shrink-0">
        <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
      </div>
      <div class="flex-1">
        <div class="bg-gray-800 rounded-lg p-3">
          <div class="flex gap-1">
            <div class="w-2 h-2 bg-primary rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
          </div>
        </div>
      </div>
    `;

    messagesContainer.appendChild(loadingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function removeLoadingMessage() {
    const loadingMessage = document.getElementById('loading-message');
    if (loadingMessage) {
      loadingMessage.remove();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const chatbotBtn = document.getElementById('chatbot-btn');
    const chatbotModal = document.getElementById('chatbot-modal');
    const closeChatbotBtn = document.getElementById('close-chatbot-btn');
    const chatForm = document.getElementById('chat-form') as HTMLFormElement;
    const chatInput = document.getElementById('chat-input') as HTMLInputElement;

    if (chatbotBtn && chatbotModal) {
      chatbotBtn.addEventListener('click', () => {
        chatbotModal.classList.remove('hidden');
        chatInput?.focus();
      });

      closeChatbotBtn?.addEventListener('click', () => {
        chatbotModal.classList.add('hidden');
      });

      chatbotModal.addEventListener('click', (e) => {
        if (e.target === chatbotModal) {
          chatbotModal.classList.add('hidden');
        }
      });

      chatForm?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const question = chatInput.value.trim();
        if (!question) return;

        addMessage(question, true);
        chatInput.value = '';
        addLoadingMessage();

        try {
          const response = await fetch('/api/chat-assistant.json', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              question: question,
              conversationHistory: conversationHistory
            }),
          });

          removeLoadingMessage();

          if (response.ok) {
            const data = await response.json();
            addMessage(data.response || 'No pude procesar tu pregunta.', false);
          } else {
            const errorData = await response.json().catch(() => ({}));
            addMessage('Lo siento, hubo un error al procesar tu pregunta. Por favor intenta de nuevo.', false);
            console.error('Error del servidor:', errorData);
          }
        } catch (error) {
          removeLoadingMessage();
          addMessage('Error de conexión. Por favor verifica tu conexión a internet.', false);
          console.error('Error de red:', error);
        }
      });
    }
  });
</script>

<style>
  /* Estilos para las respuestas HTML del chatbot */
  :global(.chatbot-response p) {
    margin-bottom: 0.75rem;
  }

  :global(.chatbot-response p:last-child) {
    margin-bottom: 0;
  }

  :global(.chatbot-response strong) {
    font-weight: 600;
    color: #3b82f6;
  }

  :global(.chatbot-response ul) {
    list-style: disc;
    margin-left: 1.25rem;
    margin-bottom: 0.75rem;
  }

  :global(.chatbot-response li) {
    margin-bottom: 0.5rem;
  }

  :global(.chatbot-response a) {
    color: #3b82f6;
    text-decoration: underline;
    transition: color 0.2s;
  }

  :global(.chatbot-response a:hover) {
    color: #2563eb;
  }
</style>
