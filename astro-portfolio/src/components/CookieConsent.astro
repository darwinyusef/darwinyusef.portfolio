---
import { getLangFromUrl } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
---

<div id="cookie-consent" class="fixed bottom-0 left-0 right-0 bg-[#1a1a2e] border-t border-gray-700 p-4 md:p-6 z-50 hidden shadow-lg">
  <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
    <div class="flex items-start gap-3 flex-1">
      <span class="material-symbols-outlined text-whitetext-blue-400 text-3xl flex-shrink-0">cookie</span>
      <div>
        <h3 class="font-bold  mb-1">
          {lang === 'es' ? 'Este sitio utiliza cookies' : lang === 'en' ? 'This site uses cookies' : 'Este site usa cookies'}
        </h3>
        <p class="text-sm text-white leading-relaxed">
          {lang === 'es'
            ? 'Utilizamos cookies para mejorar tu experiencia de navegación y analizar el tráfico del sitio.'
            : lang === 'en'
            ? 'We use cookies to enhance your browsing experience and analyze site traffic.'
            : 'Usamos cookies para melhorar sua experiência de navegação e analisar o tráfego do site.'}
          <button id="cookie-settings-btn" class="text-blue-400 hover:underline ml-1">
            {lang === 'es' ? 'Configurar cookies' : lang === 'en' ? 'Cookie settings' : 'Configurar cookies'}
          </button>
        </p>
      </div>
    </div>

    <div class="flex gap-3">
      <button
        id="cookie-reject-btn"
        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors font-medium"
      >
        {lang === 'es' ? 'Rechazar' : lang === 'en' ? 'Reject' : 'Rejeitar'}
      </button>
      <button
        id="cookie-accept-btn"
        class="px-6 py-2 bg-primary text-white rounded-lg hover:opacity-90 transition-opacity font-medium"
      >
        {lang === 'es' ? 'Aceptar' : lang === 'en' ? 'Accept' : 'Aceitar'}
      </button>
    </div>
  </div>
</div>

<div id="cookie-settings-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white dark:bg-[#1a1a2e] rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden">
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-primary/10 to-purple-600/10">
      <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-blue-400 text-3xl">cookie</span>
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white" style="font-family: 'Inter Tight', system-ui, sans-serif;">
          {lang === 'es' ? 'Preferencias de Cookies' : lang === 'en' ? 'Cookie Preferences' : 'Preferências de Cookies'}
        </h3>
      </div>
      <button id="close-settings-btn" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
        <span class="material-symbols-outlined text-2xl">close</span>
      </button>
    </div>

    <!-- Content -->
    <div class="p-6 space-y-6 max-h-[60vh] overflow-y-auto">
      <!-- Cookies Esenciales -->
      <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-5 border-2 border-gray-200 dark:border-gray-700">
        <div class="flex items-start justify-between gap-4">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <span class="material-symbols-outlined text-green-600 dark:text-green-400">verified_user</span>
              <h4 class="font-bold text-lg text-gray-900 dark:text-white">
                {lang === 'es' ? 'Cookies Esenciales' : lang === 'en' ? 'Essential Cookies' : 'Cookies Essenciais'}
              </h4>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed">
              {lang === 'es'
                ? 'Necesarias para el funcionamiento básico del sitio. No se pueden desactivar.'
                : lang === 'en'
                ? 'Required for basic site functionality. Cannot be disabled.'
                : 'Necessários para o funcionamento básico do site. Não podem ser desativados.'}
            </p>
          </div>
          <div class="flex-shrink-0">
            <div class="relative inline-block w-14 h-8 bg-green-600 rounded-full cursor-not-allowed opacity-60">
              <div class="absolute top-1 right-1 bg-white w-6 h-6 rounded-full shadow-md"></div>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 text-center">{lang === 'es' ? 'Siempre activas' : lang === 'en' ? 'Always active' : 'Sempre ativas'}</p>
          </div>
        </div>
      </div>

      <!-- Cookies de Análisis -->
      <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-5 border-2 border-gray-200 dark:border-gray-700 hover:border-primary/50 dark:hover:border-primary/50 transition-colors">
        <div class="flex items-start justify-between gap-4">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">analytics</span>
              <h4 class="font-bold text-lg text-gray-900 dark:text-white">
                {lang === 'es' ? 'Cookies de Análisis' : lang === 'en' ? 'Analytics Cookies' : 'Cookies de Análise'}
              </h4>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed mb-3">
              {lang === 'es'
                ? 'Ayudan a mejorar el sitio mediante el análisis de cómo los visitantes interactúan con él.'
                : lang === 'en'
                ? 'Help improve the site by analyzing how visitors interact with it.'
                : 'Ajudam a melhorar o site analisando como os visitantes interagem com ele.'}
            </p>
            <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
              <span class="material-symbols-outlined text-sm">info</span>
              <span>{lang === 'es' ? 'Google Analytics, métricas de uso' : lang === 'en' ? 'Google Analytics, usage metrics' : 'Google Analytics, métricas de uso'}</span>
            </div>
          </div>
          <div class="flex-shrink-0">
            <label class="relative inline-block w-14 h-8 cursor-pointer">
              <input type="checkbox" id="analytics-cookies" class="sr-only peer" />
              <div class="w-14 h-8 bg-gray-300 dark:bg-gray-600 rounded-full peer-checked:bg-primary transition-colors"></div>
              <div class="absolute top-1 left-1 bg-white w-6 h-6 rounded-full shadow-md transition-transform peer-checked:translate-x-6"></div>
            </label>
          </div>
        </div>
      </div>

      <!-- Cookies de Marketing -->
      <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-5 border-2 border-gray-200 dark:border-gray-700 hover:border-primary/50 dark:hover:border-primary/50 transition-colors">
        <div class="flex items-start justify-between gap-4">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <span class="material-symbols-outlined text-purple-600 dark:text-purple-400">campaign</span>
              <h4 class="font-bold text-lg text-gray-900 dark:text-white">
                {lang === 'es' ? 'Cookies de Marketing' : lang === 'en' ? 'Marketing Cookies' : 'Cookies de Marketing'}
              </h4>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed mb-3">
              {lang === 'es'
                ? 'Se utilizan para rastrear visitantes y mostrar anuncios relevantes y personalizados.'
                : lang === 'en'
                ? 'Used to track visitors and display relevant and personalized ads.'
                : 'Usados para rastrear visitantes e exibir anúncios relevantes e personalizados.'}
            </p>
            <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
              <span class="material-symbols-outlined text-sm">info</span>
              <span>{lang === 'es' ? 'Redes sociales, publicidad dirigida' : lang === 'en' ? 'Social media, targeted advertising' : 'Redes sociais, publicidade direcionada'}</span>
            </div>
          </div>
          <div class="flex-shrink-0">
            <label class="relative inline-block w-14 h-8 cursor-pointer">
              <input type="checkbox" id="marketing-cookies" class="sr-only peer" />
              <div class="w-14 h-8 bg-gray-300 dark:bg-gray-600 rounded-full peer-checked:bg-primary transition-colors"></div>
              <div class="absolute top-1 left-1 bg-white w-6 h-6 rounded-full shadow-md transition-transform peer-checked:translate-x-6"></div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="flex gap-3 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/30">
      <button
        id="reject-all-btn"
        class="flex-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white py-3 px-6 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors font-semibold border-2 border-gray-300 dark:border-gray-600"
      >
        {lang === 'es' ? 'Rechazar Todas' : lang === 'en' ? 'Reject All' : 'Rejeitar Todas'}
      </button>
      <button
        id="save-settings-btn"
        class="flex-1 bg-gradient-to-r from-primary to-purple-600 text-white py-3 px-6 rounded-xl hover:opacity-90 transition-opacity font-semibold shadow-lg"
      >
        {lang === 'es' ? 'Guardar Preferencias' : lang === 'en' ? 'Save Preferences' : 'Salvar Preferências'}
      </button>
    </div>
  </div>
</div>

<style>
  /* Custom scrollbar for modal */
  .max-h-\[60vh\]::-webkit-scrollbar {
    width: 6px;
  }

  .max-h-\[60vh\]::-webkit-scrollbar-track {
    background: transparent;
  }

  .max-h-\[60vh\]::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #3b82f6 0%, #8b5cf6 100%);
    border-radius: 10px;
  }

  .max-h-\[60vh\]::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #2563eb 0%, #7c3aed 100%);
  }
</style>

<script>
  function getCookieConsent() {
    return sessionStorage.getItem('cookieConsent');
  }

  function setCookieConsent(value: string) {
    sessionStorage.setItem('cookieConsent', value);
    sessionStorage.setItem('cookieConsentDate', new Date().toISOString());
  }

  function setCookiePreferences(analytics: boolean, marketing: boolean) {
    sessionStorage.setItem('analyticsConsent', analytics.toString());
    sessionStorage.setItem('marketingConsent', marketing.toString());

    // Aplicar las preferencias inmediatamente
    if (analytics) {
      console.log('✓ Cookies de análisis activadas');
      // Aquí se puede inicializar Google Analytics u otras herramientas
    } else {
      console.log('✗ Cookies de análisis desactivadas');
      // Aquí se puede desactivar Google Analytics
    }

    if (marketing) {
      console.log('✓ Cookies de marketing activadas');
      // Aquí se pueden activar scripts de marketing
    } else {
      console.log('✗ Cookies de marketing desactivadas');
      // Aquí se pueden desactivar scripts de marketing
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const cookieConsent = document.getElementById('cookie-consent');
    const cookieSettingsModal = document.getElementById('cookie-settings-modal');
    const acceptBtn = document.getElementById('cookie-accept-btn');
    const rejectBtn = document.getElementById('cookie-reject-btn');
    const settingsBtn = document.getElementById('cookie-settings-btn');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const rejectAllBtn = document.getElementById('reject-all-btn');

    const consent = getCookieConsent();

    if (!consent) {
      cookieConsent?.classList.remove('hidden');
    }

    acceptBtn?.addEventListener('click', () => {
      setCookieConsent('accepted');
      setCookiePreferences(true, true);
      cookieConsent?.classList.add('hidden');
    });

    rejectBtn?.addEventListener('click', () => {
      setCookieConsent('rejected');
      setCookiePreferences(false, false);
      cookieConsent?.classList.add('hidden');
    });

    // Cargar preferencias actuales desde sessionStorage
    function loadCurrentPreferences() {
      const analyticsConsent = sessionStorage.getItem('analyticsConsent') === 'true';
      const marketingConsent = sessionStorage.getItem('marketingConsent') === 'true';
      const analyticsCheckbox = document.getElementById('analytics-cookies') as HTMLInputElement;
      const marketingCheckbox = document.getElementById('marketing-cookies') as HTMLInputElement;

      if (analyticsCheckbox) analyticsCheckbox.checked = analyticsConsent;
      if (marketingCheckbox) marketingCheckbox.checked = marketingConsent;
    }

    // Event listeners para cambios inmediatos en los toggles
    const analyticsCheckbox = document.getElementById('analytics-cookies') as HTMLInputElement;
    const marketingCheckbox = document.getElementById('marketing-cookies') as HTMLInputElement;

    analyticsCheckbox?.addEventListener('change', (e) => {
      const isChecked = (e.target as HTMLInputElement).checked;
      const marketingChecked = marketingCheckbox?.checked || false;
      setCookiePreferences(isChecked, marketingChecked);
    });

    marketingCheckbox?.addEventListener('change', (e) => {
      const isChecked = (e.target as HTMLInputElement).checked;
      const analyticsChecked = analyticsCheckbox?.checked || false;
      setCookiePreferences(analyticsChecked, isChecked);
    });

    settingsBtn?.addEventListener('click', () => {
      cookieSettingsModal?.classList.remove('hidden');
      // Cargar preferencias actuales al abrir el modal
      loadCurrentPreferences();
    });

    closeSettingsBtn?.addEventListener('click', () => {
      cookieSettingsModal?.classList.add('hidden');
    });

    rejectAllBtn?.addEventListener('click', () => {
      setCookieConsent('rejected');
      setCookiePreferences(false, false);
      cookieConsent?.classList.add('hidden');
      cookieSettingsModal?.classList.add('hidden');
    });

    saveSettingsBtn?.addEventListener('click', () => {
      // Las preferencias ya se guardaron automáticamente al cambiar los toggles
      // Solo necesitamos marcar el consentimiento como personalizado y cerrar el modal
      setCookieConsent('customized');

      cookieConsent?.classList.add('hidden');
      cookieSettingsModal?.classList.add('hidden');
    });

    cookieSettingsModal?.addEventListener('click', (e) => {
      if (e.target === cookieSettingsModal) {
        cookieSettingsModal.classList.add('hidden');
      }
    });
  });
</script>
