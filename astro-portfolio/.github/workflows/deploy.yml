name: Deploy to Production

on:
  push:
    branches:
      - main
    paths:
      - 'astro-portfolio/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ========================================
  # Build and Test
  # ========================================
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./astro-portfolio

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: astro-portfolio/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint || echo "Lint failed but continuing"
        continue-on-error: true

      - name: Build application
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: astro-portfolio/dist/
          retention-days: 1

  # ========================================
  # Deploy to Server
  # ========================================
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 30m
          script: |
            echo "üöÄ Starting deployment with Caddy + HTTPS..."

            # Navegar al directorio del proyecto
            cd /opt/portfolio || exit 1

            # Hacer pull de los √∫ltimos cambios
            echo "üì• Pulling latest changes from GitHub..."
            git pull origin main

            # Navegar al directorio de la aplicaci√≥n
            cd astro-portfolio || exit 1

            # Detener contenedores actuales (sin eliminar vol√∫menes)
            echo "‚è∏Ô∏è  Stopping current containers..."
            docker compose -f docker-compose-caddy.yml down

            # Construir y levantar nueva versi√≥n con Caddy
            echo "üî® Building and starting new containers (Portfolio + Caddy + Minio)..."
            docker compose -f docker-compose-caddy.yml up -d --build

            # Esperar a que los contenedores est√©n saludables
            echo "‚è≥ Waiting for containers to be healthy..."
            sleep 20

            # Limpiar recursos no utilizados
            echo "üßπ Cleaning up unused Docker resources..."
            docker system prune -f

            # Verificar que los contenedores est√°n corriendo
            echo "‚úÖ Checking containers status..."
            docker ps | grep -E '(astro-portfolio|portfolio-caddy)' || exit 1

            # Verificar certificados SSL
            echo "üîí Checking SSL certificates..."
            docker exec portfolio-caddy caddy list-certificates | head -n 5

            # Reload Caddy sin downtime
            echo "üîÑ Reloading Caddy configuration..."
            docker exec portfolio-caddy caddy reload --config /etc/caddy/Caddyfile

            echo "üéâ Deployment completed successfully with HTTPS!"

      - name: Health check
        run: |
          echo "üè• Performing health check..."
          sleep 10

          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.SITE_URL }})

          if [ $response -eq 200 ]; then
            echo "‚úÖ Health check passed! Site is responding with status code: $response"
          else
            echo "‚ùå Health check failed! Site returned status code: $response"
            exit 1
          fi

  # ========================================
  # Notify
  # ========================================
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [build-test, deploy]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Message:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üåê **Live Site:** https://darwinyusef.com" >> $GITHUB_STEP_SUMMARY

      - name: Deployment status
        if: success()
        run: |
          echo "‚úÖ Deployment successful! Portfolio is live at https://darwinyusef.com"

      - name: Deployment failed
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Please check the logs above for details."
          exit 1
