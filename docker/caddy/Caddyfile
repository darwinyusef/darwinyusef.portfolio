# ============================================
# Caddy - Reverse Proxy Multi-Domain
# HTTPS with Let's Encrypt
# ============================================

{
	email {$ACME_EMAIL}
	servers {
		trusted_proxies static 0.0.0.0/0
	}
}

# ============================================
# Main Domain - darwinyusef.com (es, en, pt)
# ============================================
darwinyusef.com, www.darwinyusef.com {
	reverse_proxy astro-portfolio:8080 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	@lang_en path /en /en/*
	@lang_pt path /pt /pt/*

	log {
		output file /var/log/caddy/darwinyusef.log
		format json
	}

	encode gzip zstd

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		Content-Language "es, en, pt"
		-Server
	}
}

# ============================================
# Domain - Aquicreamos.com
# ============================================
aquicreamos.com, www.aquicreamos.com {
	reverse_proxy aquicreamos:4321 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	log {
		output file /var/log/caddy/aquicreamos.log
		format json
	}

	encode gzip zstd

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}
}

# ============================================
# Subdomain - API
# ============================================
api.darwinyusef.com {
	reverse_proxy portfolio-backend:3001 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	log {
		output file /var/log/caddy/api.log
		format json
	}

	encode gzip zstd

	header {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
		-Server
	}
}

# ============================================
# Subdomain - MinIO (Storage)
# ============================================
minio.darwinyusef.com {
	reverse_proxy portfolio-minio:9000 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	log {
		output file /var/log/caddy/minio.log
	}

	encode gzip
}

# ============================================
# Subdomain - MinIO Console
# ============================================
console.darwinyusef.com {
	reverse_proxy portfolio-minio:9090 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	log {
		output file /var/log/caddy/minio-console.log
	}
}
